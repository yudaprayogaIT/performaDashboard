// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =============================================
// USERS & PERMISSIONS
// =============================================

model User {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  email     String   @unique @db.VarChar(100)
  password  String   @db.VarChar(255)
  isActive  Boolean  @default(true) @map("is_active")
  
  // Audit fields
  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   Int?      @map("created_by")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  updatedBy   Int?      @map("updated_by")
  
  // Login tracking
  lastLoginAt DateTime? @map("last_login_at")
  lastLoginIp String?   @db.VarChar(45) @map("last_login_ip")

  // Relations
  userRoles     UserRole[]
  uploadBatches UploadBatch[]

  @@map("users")
}

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(50)
  description String?  @db.VarChar(255)
  isActive    Boolean  @default(true) @map("is_active")
  
  // Audit fields
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy Int?      @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy Int?      @map("updated_by")

  // Relations
  userRoles   UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(100)
  description String? @db.VarChar(255)
  module      String  @db.VarChar(50)
  
  // Audit fields
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy Int?      @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy Int?      @map("updated_by")

  // Relations
  roles RolePermission[]

  @@map("permissions")
}

model UserRole {
  userId Int @map("user_id")
  roleId Int @map("role_id")
  
  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  createdBy Int?     @map("created_by")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       Int @map("role_id")
  permissionId Int @map("permission_id")
  
  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  createdBy Int?     @map("created_by")

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// =============================================
// MASTER DATA
// =============================================

model Location {
  id       Int          @id @default(autoincrement())
  code     String       @unique @db.VarChar(20)
  name     String       @db.VarChar(100)
  type     LocationType
  address  String?      @db.Text
  isActive Boolean      @default(true) @map("is_active")
  
  // Audit fields
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy Int?      @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy Int?      @map("updated_by")

  // Relations
  sales Sale[]

  @@map("locations")
}

enum LocationType {
  LOCAL
  CABANG
}

model Category {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(100)
  description String? @db.VarChar(255)
  sortOrder   Int     @default(0) @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")
  
  // Audit fields
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy Int?      @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy Int?      @map("updated_by")

  // Relations
  sales          Sale[]
  targets        Target[]
  dailySummaries SalesDailySummary[]

  @@map("categories")
}

// =============================================
// TARGET SETTINGS
// =============================================

model Target {
  id           Int          @id @default(autoincrement())
  year         Int
  month        Int // 1-12, atau 0 untuk target tahunan
  locationType LocationType @map("location_type")
  categoryId   Int?         @map("category_id")
  targetAmount Decimal      @db.Decimal(20, 2) @map("target_amount")
  
  // Audit fields
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy Int?      @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy Int?      @map("updated_by")

  // Relations
  category Category? @relation(fields: [categoryId], references: [id])

  @@unique([year, month, locationType, categoryId], name: "unique_target")
  @@map("targets")
}

// =============================================
// SALES DATA
// =============================================

model Sale {
  id            BigInt   @id @default(autoincrement())
  saleDate      DateTime @map("sale_date") @db.Date
  locationId    Int      @map("location_id")
  categoryId    Int      @map("category_id")
  itemName      String?  @db.VarChar(255) @map("item_name")
  quantity      Int      @default(1)
  amount        Decimal  @db.Decimal(20, 2)
  notes         String?  @db.Text
  uploadBatchId Int?     @map("upload_batch_id")
  
  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  createdBy Int?     @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy Int?     @map("updated_by")

  // Relations
  location    Location     @relation(fields: [locationId], references: [id])
  category    Category     @relation(fields: [categoryId], references: [id])
  uploadBatch UploadBatch? @relation(fields: [uploadBatchId], references: [id])

  @@index([saleDate])
  @@index([locationId])
  @@index([categoryId])
  @@index([saleDate, locationId])
  @@map("sales")
}

model SalesDailySummary {
  id               BigInt       @id @default(autoincrement())
  summaryDate      DateTime     @map("summary_date") @db.Date
  locationType     LocationType @map("location_type")
  categoryId       Int          @map("category_id")
  totalAmount      Decimal      @db.Decimal(20, 2) @map("total_amount")
  transactionCount Int          @default(0) @map("transaction_count")
  
  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  createdBy Int?     @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy Int?     @map("updated_by")

  // Relations
  category Category @relation(fields: [categoryId], references: [id])

  @@unique([summaryDate, locationType, categoryId], name: "unique_daily")
  @@index([summaryDate])
  @@index([locationType])
  @@map("sales_daily_summary")
}

// =============================================
// UPLOAD LOGS
// =============================================

model UploadBatch {
  id           Int          @id @default(autoincrement())
  uploadedBy   Int          @map("uploaded_by")
  filename     String       @db.VarChar(255)
  fileSize     Int?         @map("file_size")
  periodMonth  Int          @map("period_month")
  periodYear   Int          @map("period_year")
  recordsCount Int          @default(0) @map("records_count")
  status       UploadStatus @default(PROCESSING)
  errorMessage String?      @db.Text @map("error_message")
  
  // Audit fields
  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   Int?      @map("created_by")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  updatedBy   Int?      @map("updated_by")
  completedAt DateTime? @map("completed_at")

  // Relations
  user  User   @relation(fields: [uploadedBy], references: [id])
  sales Sale[]

  @@map("upload_batches")
}

enum UploadStatus {
  PROCESSING
  SUCCESS
  FAILED
  PARTIAL
}