// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =============================================
// USERS & PERMISSIONS
// =============================================

model User {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  email     String   @unique @db.VarChar(100)
  password  String   @db.VarChar(255)
  isActive  Boolean  @default(true) @map("is_active")

  // Audit fields
  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   Int?      @map("created_by")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  updatedBy   Int?      @map("updated_by")

  // Login tracking
  lastLoginAt DateTime? @map("last_login_at")
  lastLoginIp String?   @db.VarChar(45) @map("last_login_ip")

  // Relations
  userRoles     UserRole[]
  uploadBatches UploadBatch[]
  salesUploads  SalesUpload[]
  auditLogs     AuditLog[]
  notifications Notification[]

  @@map("users")
}

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(50)
  description String?  @db.VarChar(255)
  isActive    Boolean  @default(true) @map("is_active")
  isSystem    Boolean  @default(false) @map("is_system") // Cannot be deleted if true

  // Audit fields
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy Int?      @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy Int?      @map("updated_by")

  // Relations
  userRoles   UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          Int              @id @default(autoincrement())
  slug        String           @unique @db.VarChar(50) // "view_dashboard", "upload_omzet"
  name        String           @db.VarChar(100) // "View Dashboard"
  description String           @db.Text
  module      PermissionModule // Grouping
  isSystem    Boolean          @default(false) @map("is_system") // Cannot be deleted if true

  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  createdBy Int?     @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy Int?     @map("updated_by")

  // Relations
  roles RolePermission[]

  @@map("permissions")
}

enum PermissionModule {
  DASHBOARD
  UPLOAD
  SETTINGS
  AUDIT
  EXPORT
}

model UserRole {
  userId Int @map("user_id")
  roleId Int @map("role_id")
  
  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  createdBy Int?     @map("created_by")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       Int @map("role_id")
  permissionId Int @map("permission_id")
  
  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  createdBy Int?     @map("created_by")

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// =============================================
// MASTER DATA
// =============================================

model Location {
  id       Int          @id @default(autoincrement())
  code     String       @unique @db.VarChar(20)
  name     String       @db.VarChar(100)
  type     LocationType
  address  String?      @db.Text
  isActive Boolean      @default(true) @map("is_active")
  
  // Audit fields
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy Int?      @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy Int?      @map("updated_by")

  // Relations
  sales Sale[]

  @@map("locations")
}

enum LocationType {
  LOCAL
  CABANG
}

model Category {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(100)
  description String? @db.VarChar(255)
  sortOrder   Int     @default(0) @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")
  
  // Audit fields
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy Int?      @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy Int?      @map("updated_by")

  // Relations
  sales          Sale[]
  targets        Target[]
  dailySummaries SalesDailySummary[]
  returs         Retur[]
  grossMargins   GrossMargin[]

  @@map("categories")
}

// =============================================
// TARGET SETTINGS
// =============================================

model Target {
  id           Int          @id @default(autoincrement())
  year         Int
  month        Int // 1-12, atau 0 untuk target tahunan
  locationType LocationType @map("location_type")
  categoryId   Int?         @map("category_id")
  targetAmount Decimal      @db.Decimal(20, 2) @map("target_amount")
  
  // Audit fields
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy Int?      @map("created_by")
  updatedAt DateTime  @updatedAt @map("updated_at")
  updatedBy Int?      @map("updated_by")

  // Relations
  category Category? @relation(fields: [categoryId], references: [id])

  @@unique([year, month, locationType, categoryId], name: "unique_target")
  @@map("targets")
}

// =============================================
// SALES DATA
// =============================================

model Sale {
  id            BigInt   @id @default(autoincrement())
  saleDate      DateTime @map("sale_date") @db.Date
  locationId    Int      @map("location_id")
  categoryId    Int      @map("category_id")
  itemName      String?  @db.VarChar(255) @map("item_name")
  quantity      Int      @default(1)
  amount        Decimal  @db.Decimal(20, 2)
  notes         String?  @db.Text
  uploadBatchId Int?     @map("upload_batch_id")
  
  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  createdBy Int?     @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy Int?     @map("updated_by")

  // Relations
  location    Location     @relation(fields: [locationId], references: [id])
  category    Category     @relation(fields: [categoryId], references: [id])
  uploadBatch UploadBatch? @relation(fields: [uploadBatchId], references: [id])

  @@index([saleDate])
  @@index([locationId])
  @@index([categoryId])
  @@index([saleDate, locationId])
  @@map("sales")
}

model SalesDailySummary {
  id               BigInt       @id @default(autoincrement())
  summaryDate      DateTime     @map("summary_date") @db.Date
  locationType     LocationType @map("location_type")
  categoryId       Int          @map("category_id")
  totalAmount      Decimal      @db.Decimal(20, 2) @map("total_amount")
  transactionCount Int          @default(0) @map("transaction_count")
  
  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  createdBy Int?     @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy Int?     @map("updated_by")

  // Relations
  category Category @relation(fields: [categoryId], references: [id])

  @@unique([summaryDate, locationType, categoryId], name: "unique_daily")
  @@index([summaryDate])
  @@index([locationType])
  @@map("sales_daily_summary")
}

// =============================================
// UPLOAD LOGS
// =============================================

model UploadBatch {
  id           Int          @id @default(autoincrement())
  uploadedBy   Int          @map("uploaded_by")
  filename     String       @db.VarChar(255)
  fileSize     Int?         @map("file_size")
  periodMonth  Int          @map("period_month")
  periodYear   Int          @map("period_year")
  recordsCount Int          @default(0) @map("records_count")
  status       UploadStatus @default(PROCESSING)
  errorMessage String?      @db.Text @map("error_message")
  
  // Audit fields
  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   Int?      @map("created_by")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  updatedBy   Int?      @map("updated_by")
  completedAt DateTime? @map("completed_at")

  // Relations
  user  User   @relation(fields: [uploadedBy], references: [id])
  sales Sale[]

  @@map("upload_batches")
}

enum UploadStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
  PARTIAL
}

// =============================================
// SALES UPLOAD TRACKING (NEW)
// =============================================

model SalesUpload {
  id           Int          @id @default(autoincrement())
  userId       Int          @map("user_id")
  uploadType   UploadType   @map("upload_type")
  fileName     String       @db.VarChar(255) @map("file_name")
  fileSize     Int // in bytes
  rowCount     Int          @map("row_count") // jumlah rows yang diupload
  status       UploadStatus @default(PENDING)
  errorMessage String?      @db.Text @map("error_message")
  uploadDate   DateTime     @map("upload_date") @db.Date // Date of the sales data
  processedAt  DateTime?    @map("processed_at")
  createdAt    DateTime     @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId, uploadType, uploadDate])
  @@index([uploadDate])
  @@map("sales_uploads")
}

enum UploadType {
  OMZET
  GROSS_MARGIN
  RETUR
}

// =============================================
// AUDIT LOG
// =============================================

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?     @map("user_id")
  action    String   @db.VarChar(100) // "CREATE_ROLE", "UPDATE_PERMISSION", "UPLOAD_OMZET"
  entity    String   @db.VarChar(50) // "Role", "Permission", "SalesData"
  entityId  Int?     @map("entity_id")
  oldValue  Json?    @map("old_value") // Snapshot before change
  newValue  Json?    @map("new_value") // Snapshot after change
  ipAddress String?  @db.VarChar(45) @map("ip_address")
  userAgent String?  @db.Text @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

// =============================================
// NOTIFICATION SYSTEM
// =============================================

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int              @map("user_id")
  title     String           @db.VarChar(255)
  message   String           @db.Text
  type      NotificationType @default(INFO)
  link      String?          @db.VarChar(500) // Deep link ke page terkait
  isRead    Boolean          @default(false) @map("is_read")
  readAt    DateTime?        @map("read_at")
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

// =============================================
// RETUR DATA
// =============================================

model Retur {
  id              BigInt       @id @default(autoincrement())
  salesInvoice    String       @db.VarChar(50) @map("sales_invoice") // RJ-2025-12-0001
  postingDate     DateTime     @map("posting_date") @db.Date
  sellingAmount   Decimal      @db.Decimal(20, 2) @map("selling_amount") // Nilai jual yang diretur
  buyingAmount    Decimal      @db.Decimal(20, 2) @map("buying_amount") // Nilai beli/HPP yang diretur
  categoryId      Int          @map("category_id")
  locationType    LocationType @map("location_type") // CABANG or LOKAL
  uploadBatchId   Int?         @map("upload_batch_id")

  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  createdBy Int?     @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy Int?     @map("updated_by")

  // Relations
  category Category @relation(fields: [categoryId], references: [id])

  @@index([postingDate])
  @@index([categoryId])
  @@index([locationType])
  @@index([postingDate, locationType])
  @@map("returs")
}

// =============================================
// GROSS MARGIN DATA
// =============================================

model GrossMargin {
  id            BigInt       @id @default(autoincrement())
  recordDate    DateTime     @map("record_date") @db.Date // Tanggal transaksi
  categoryId    Int          @map("category_id")
  locationType  LocationType @map("location_type") // CABANG or LOKAL
  omzetAmount   Decimal      @db.Decimal(20, 2) @map("omzet_amount") // Revenue
  hppAmount     Decimal      @db.Decimal(20, 2) @map("hpp_amount") // Cost of Goods Sold
  marginAmount  Decimal      @db.Decimal(20, 2) @map("margin_amount") // Gross Margin = Omzet - HPP
  marginPercent Decimal      @db.Decimal(5, 2) @map("margin_percent") // Margin % = (Margin / Omzet) * 100
  uploadBatchId Int?         @map("upload_batch_id")

  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  createdBy Int?     @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy Int?     @map("updated_by")

  // Relations
  category Category @relation(fields: [categoryId], references: [id])

  @@index([recordDate])
  @@index([categoryId])
  @@index([locationType])
  @@index([recordDate, locationType])
  @@unique([recordDate, categoryId, locationType], name: "unique_gm_record")
  @@map("gross_margins")
}